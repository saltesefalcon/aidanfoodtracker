<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Food Transfer Tracker</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 20px; }
    h1, h2 { text-align: center; }
    .section { margin: 30px 0; }
    .log-entry { margin: 4px 0; padding: 6px; border-left: 4px solid gray; }
    .positive { color: green; border-left-color: green; }
    .negative { color: red; border-left-color: red; }
    .month-nav { text-align: center; margin-bottom: 10px; }
    .month-nav button { margin: 0 5px; }
    details { margin-bottom: 20px; }
  </style>
</head>
<body>
  <h1>Food Transfer Tracker</h1>

  <div class="section">
    <h2>Log a Transfer</h2>
    <input type="date" id="transferDate" />
    <select id="fromLocation">
      <option value="Prohibition">Prohibition</option>
      <option value="Tulia">Tulia</option>
      <option value="Beacon">Beacon</option>
      <option value="Ce Soir">Ce Soir</option>
    </select>
    to
    <select id="toLocation">
      <option value="Prohibition">Prohibition</option>
      <option value="Tulia">Tulia</option>
      <option value="Beacon">Beacon</option>
      <option value="Ce Soir">Ce Soir</option>
    </select>
    <br/><br/>
    Product: <input type="text" id="productName" placeholder="e.g. Chicken Thighs" />
    Amount: <input type="number" id="productAmount" />
    <select id="unit">
      <option value="oz">oz</option>
      <option value="lb">lb</option>
      <option value="kg">kg</option>
      <option value="fl oz">fl oz</option>
      <option value="ml">ml</option>
      <option value="L">L</option>
    </select>
    <button onclick="submitTransfer()">Submit Transfer</button>
  </div>

  <div class="section">
    <h2>Logs</h2>
    <div class="month-nav">
      <button onclick="prevMonth()">←</button>
      <span id="monthLabel"></span>
      <button onclick="nextMonth()">→</button>
    </div>
    <div id="logsOutput">Loading logs...</div>
    <button onclick="downloadReport()">Download Monthly Report</button>
  </div>

  <!-- Firebase & App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAdWAxKfSLI7jf7vJSwrIXogvL3LRW-GFU",
      authDomain: "aidan-food-tracker.firebaseapp.com",
      projectId: "aidan-food-tracker",
      storageBucket: "aidan-food-tracker.firebasestorage.app",
      messagingSenderId: "397728832351",
      appId: "1:397728832351:web:33645f7f37ee1f277ff4ea",
      databaseURL: "https://aidan-food-tracker-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const locations = ["Prohibition", "Tulia", "Beacon", "Ce Soir"];
    let currentMonth = new Date();

    function getMonthKey(dateObj) {
      const year = dateObj.getFullYear();
      const month = String(dateObj.getMonth() + 1).padStart(2, '0');
      return `${year}-${month}`;
    }

    function submitTransfer() {
      const date = document.getElementById("transferDate").value;
      const from = document.getElementById("fromLocation").value;
      const to = document.getElementById("toLocation").value;
      const product = document.getElementById("productName").value.trim();
      const amount = parseFloat(document.getElementById("productAmount").value);
      const unit = document.getElementById("unit").value;

      if (!date || !product || isNaN(amount)) {
        alert("Please fill all fields correctly.");
        return;
      }

      const monthKey = date.slice(0, 7); // YYYY-MM
      const timestamp = Date.now();

      const log = { date, product, amount, unit, from, to, timestamp };

      push(ref(db, `logs/${from}/${monthKey}`), { ...log, type: "out" });
      push(ref(db, `logs/${to}/${monthKey}`), { ...log, type: "in" });

      alert("Transfer logged successfully!");
      loadLogs();
    }

    function loadLogs() {
      const logsDiv = document.getElementById("logsOutput");
      const monthKey = getMonthKey(currentMonth);
      document.getElementById("monthLabel").textContent = monthKey;

      logsDiv.innerHTML = "";

      locations.forEach(loc => {
        const locRef = ref(db, `logs/${loc}/${monthKey}`);
        onValue(locRef, snapshot => {
          const data = snapshot.val();
          let html = `<details><summary><strong>${loc}</strong></summary>`;

          if (data) {
            const entries = Object.values(data).sort((a, b) => a.timestamp - b.timestamp);
            entries.forEach(entry => {
              const style = entry.type === "in" ? "positive" : "negative";
              html += `<div class="log-entry ${style}">
                ${entry.date} — ${entry.type === "in" ? "+" : "-"}${entry.amount} ${entry.unit} ${entry.product} (${entry.from} → ${entry.to})
              </div>`;
            });
          } else {
            html += "<p>No logs for this month.</p>";
          }

          html += `</details>`;
          logsDiv.innerHTML += html;
        });
      });
    }

    function prevMonth() {
      currentMonth.setMonth(currentMonth.getMonth() - 1);
      loadLogs();
    }

    function nextMonth() {
      currentMonth.setMonth(currentMonth.getMonth() + 1);
      loadLogs();
    }

    window.submitTransfer = submitTransfer;
    window.prevMonth = prevMonth;
    window.nextMonth = nextMonth;

    // EXCEL DOWNLOAD
    window.downloadReport = async function () {
      const monthKey = getMonthKey(currentMonth);
      const wb = XLSX.utils.book_new();

      for (const loc of locations) {
        const snapshot = await new Promise(resolve => {
          onValue(ref(db, `logs/${loc}/${monthKey}`), resolve, { onlyOnce: true });
        });

        const data = snapshot.val();
        if (!data) continue;

        const rows = [["Date", "Type", "Product", "Amount", "Unit", "From", "To"]];
        Object.values(data).forEach(log => {
          rows.push([
            log.date,
            log.type,
            log.product,
            log.amount,
            log.unit,
            log.from,
            log.to
          ]);
        });

        const sheet = XLSX.utils.aoa_to_sheet(rows);
        XLSX.utils.book_append_sheet(wb, sheet, loc);
      }

      XLSX.writeFile(wb, `Food_Transfers_${monthKey}.xlsx`);
    };

    window.addEventListener("DOMContentLoaded", loadLogs);
  </script>
</body>
</html>

    loadLogs(); // Initial load
  </script>
</body>
</html>
