<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Food Transfer Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <!-- Firebase + SheetJS -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, push, update, get } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";
    import * as XLSX from "https://cdn.sheetjs.com/xlsx-0.20.0/package/xlsx.mjs";

    const firebaseConfig = {
      apiKey: "AIzaSyAdWAxKfSLI7jf7vJSwrIXogvL3LRW-GFU",
      authDomain: "aidan-food-tracker.firebaseapp.com",
      projectId: "aidan-food-tracker",
      storageBucket: "aidan-food-tracker.appspot.com",
      messagingSenderId: "397728832351",
      appId: "1:397728832351:web:33645f7f37ee1f277ff4ea",
      databaseURL: "https://aidan-food-tracker-default-rtdb.firebaseio.com"
    };

    const emailMap = {
      "Prohibition": "prohibition@example.com",
      "Tulia Osteria": "tulia@example.com",
      "Ce Soir": "cesoir@example.com",
      "Beacon": "beacon@example.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const locations = Object.keys(emailMap);
    const units = ["oz", "lb", "kg", "fl oz", "ml", "L"];
    let selectedMonth = new Date().toISOString().slice(0, 7);

    function $(id) { return document.getElementById(id); }

    function setupUI() {
      emailjs.init("service_gnviol9");

      locations.forEach(loc => {
        ["from", "to"].forEach(id => {
          const opt = document.createElement("option");
          opt.value = opt.textContent = loc;
          $(id).appendChild(opt);
        });
      });
      units.forEach(unit => {
        const opt = document.createElement("option");
        opt.value = opt.textContent = unit;
        $("unit").appendChild(opt);
      });

      $("unit").addEventListener("change", updateUnitLabel);
      ["cost", "amount"].forEach(id => $(id).addEventListener("input", updateTotalValue));

      $("from").addEventListener("change", () => {
        const fromVal = $("from").value;
        [...$("to").options].forEach(opt => opt.disabled = opt.value === fromVal);
      });
    }

    function updateUnitLabel() {
      $("unit-label").textContent = $("unit").value;
      updateTotalValue();
    }

    function updateTotalValue() {
      const a = parseFloat($("amount").value);
      const c = parseFloat($("cost").value);
      $("total-value").textContent = (!isNaN(a) && !isNaN(c)) ? `Total Value: $${(a * c).toFixed(2)}` : "";
    }

    async function getNextInvoiceNumber() {
      const counterRef = ref(db, "invoiceCounter");
      const snapshot = await get(counterRef);
      let current = snapshot.exists() ? snapshot.val() : 1000;
      await update(ref(db), { invoiceCounter: current + 1 });
      return current + 1;
    }

    window.createInvoice = async function(store, month, id) {
      const logRef = ref(db, `logs/${store}/${month}/${id}`);
      const snapshot = await get(logRef);
      const log = snapshot.val();
      if (!log) return alert("Log not found.");

      const invoiceNumber = await getNextInvoiceNumber();
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const isOut = log.from === store;
      const sign = isOut ? "-" : "+";
      const amountVal = isOut ? -log.amount : log.amount;
      const total = log.costPerUnit ? (amountVal * log.costPerUnit).toFixed(2) : "N/A";

      doc.setFontSize(16);
      doc.text(`Invoice #${invoiceNumber}`, 20, 20);
      doc.setFontSize(12);
      doc.text(`From: ${log.from}`, 20, 30);
      doc.text(`To: ${log.to}`, 20, 40);
      doc.text(`Date: ${log.date}`, 20, 50);
      doc.text(`Product: ${log.product}`, 20, 60);
      doc.text(`Amount: ${sign}${log.amount} ${log.unit}`, 20, 70);
      doc.text(`Cost per unit: $${log.costPerUnit ?? "N/A"}`, 20, 80);
      doc.text(`Total Value: $${total}`, 20, 90);
      doc.text(`Direction: ${isOut ? "Outgoing" : "Incoming"}`, 20, 100);

      const pdfData = doc.output("datauristring");
      const recipient = isOut ? emailMap[log.from] : emailMap[log.to];

      emailjs.send("service_gnviol9", "template_6d3c34k", {
        to_email: recipient,
        message: `Invoice #${invoiceNumber}\nFrom: ${log.from}\nTo: ${log.to}\nDate: ${log.date}\nProduct: ${log.product}\nAmount: ${sign}${log.amount} ${log.unit}\nCost per unit: $${log.costPerUnit}\nTotal: $${total}`,
        attachment: pdfData
      }).then(() => {
        alert(`Invoice #${invoiceNumber} sent to ${recipient}`);
      }, err => {
        console.error("EmailJS error:", err);
        alert("Failed to send invoice.");
      });
    };

  </script>
</head>
<body>
  <!-- Your HTML body content here -->
</body>
</html>

