<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Food Transfer Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* ——— Tracker8 CSS ——— */
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    header { background: #333; color: #fff; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
    #login-container, #app-container { padding: 1rem; }
    #app-container { display: none; }
    form { margin-bottom: 2rem; }
    .item-input { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }
    .item-input input, .item-input select { padding: 0.5rem; }
    select.location-select { padding: 0.5rem; margin-right: 0.5rem; }
    button { padding: 0.5rem 1rem; margin-right: 0.5rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    th { background: #f5f5f5; }
  </style>
</head>
<body>
  <!-- LOGIN SCREEN -->
  <div id="login-container">
    <h2>Login</h2>
    <form id="login-form">
      <input type="email" id="email" placeholder="Email" required />
      <input type="password" id="password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
    <p id="login-error" style="color:red;"></p>
  </div>

  <!-- MAIN APP -->
  <div id="app-container">
    <header>
      <span id="user-email"></span>
      <button id="logout-button">Logout</button>
    </header>
    <main>
      <h2>Create Transfer & Invoice</h2>
      <form id="transfer-form">
        <select id="from-location" class="location-select">
          <option value="">From Location</option>
        </select>
        <select id="to-location" class="location-select">
          <option value="">To Location</option>
        </select>
        <div class="item-input" data-index="0">
          <input type="text" id="product-0" placeholder="Product" required />
          <input type="number" id="weight-0" placeholder="Weight" required />
          <select id="unit-0">
            <option value="kg">kg</option>
            <option value="lb">lb</option>
            <option value="pcs">pcs</option>
          </select>
          <input type="number" id="cost-0" placeholder="Cost per unit" required />
        </div>
        <button type="button" id="add-item-button">More Items</button>
        <button type="submit" id="create-invoice-button">Create Invoice</button>
      </form>

      <h2>Logs</h2>
      <table id="logs-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>From</th>
            <th>To</th>
            <th>Product</th>
            <th>Weight</th>
            <th>Unit</th>
            <th>Cost</th>
            <th>Total</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <button id="export-excel-button">Export Monthly Report</button>
    </main>
  </div>

  <!-- LIBRARIES -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import {
      getDatabase,
      ref,
      push,
      update,
      get,
      onChildAdded
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";
    import * as XLSX from "https://cdn.sheetjs.com/xlsx-0.20.0/package/xlsx.mjs";

    // EmailJS init
    import emailjs from "https://cdn.emailjs.com/dist/email.min.js";
    emailjs.init("53xKou9OzR6BhrdWL");

    // ——— Firebase Config ———
    const firebaseConfig = {
      apiKey: "AIzaSyAdWAxKfSLI7jf7vJSwrIXogvL3LRW-GFU",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DB_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MSG_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    // ——— UI Elements ———
    const loginContainer = document.getElementById("login-container");
    const appContainer   = document.getElementById("app-container");
    const loginForm      = document.getElementById("login-form");
    const emailInput     = document.getElementById("email");
    const passwordInput  = document.getElementById("password");
    const loginError     = document.getElementById("login-error");
    const logoutButton   = document.getElementById("logout-button");
    const userEmailSpan  = document.getElementById("user-email");
    const fromSelect     = document.getElementById("from-location");
    const toSelect       = document.getElementById("to-location");
    const transferForm   = document.getElementById("transfer-form");
    const addItemBtn     = document.getElementById("add-item-button");
    const logsTableBody  = document.querySelector("#logs-table tbody");
    const exportBtn      = document.getElementById("export-excel-button");

    // ——— Locations & Emails ———
    const locations = ["Prohibition", "Beacon", "Tulia Osteria", "Ce Soir"];
    const emailMap  = {
      "Prohibition":    "accounts@prohibitionsocialhouse.com",
      "Beacon":         "accounts@beaconsocialhouse.com",
      "Tulia Osteria":  "accounts@tuliaosteria.com",
      "Ce Soir":        "accounts@cesoirbrasserie.com"
    };
    locations.forEach(loc => {
      const o1 = document.createElement("option");
      o1.value = loc; o1.textContent = loc;
      fromSelect.appendChild(o1);
      const o2 = o1.cloneNode(true);
      toSelect.appendChild(o2);
    });

    // ——— Auth Handling ———
    onAuthStateChanged(auth, user => {
      if (user) {
        loginContainer.style.display = "none";
        appContainer.style.display   = "block";
        userEmailSpan.textContent    = user.email;
      } else {
        loginContainer.style.display = "block";
        appContainer.style.display   = "none";
      }
    });
    loginForm.addEventListener("submit", e => {
      e.preventDefault();
      signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value)
        .catch(err => loginError.textContent = err.message);
    });
    logoutButton.addEventListener("click", () => signOut(auth));

    // ——— Dynamic Item Inputs ———
    let itemIndex = 1;
    addItemBtn.addEventListener("click", () => {
      const div = document.createElement("div");
      div.className = "item-input";
      div.dataset.index = itemIndex;
      div.innerHTML = `
        <input type="text"    id="product-${itemIndex}" placeholder="Product" required />
        <input type="number"  id="weight-${itemIndex}"  placeholder="Weight" required />
        <select           id="unit-${itemIndex}">
          <option value="kg">kg</option>
          <option value="lb">lb</option>
          <option value="pcs">pcs</option>
        </select>
        <input type="number"  id="cost-${itemIndex}"    placeholder="Cost per unit" required />
      `;
      transferForm.insertBefore(div, addItemBtn);
      itemIndex++;
    });

    // ——— Invoice Number Generator ———
    function generateInvoiceNumber() {
      return 'INV-' + Date.now();
    }

    // ——— Submit Transfer & Invoice ———
    transferForm.addEventListener("submit", async e => {
      e.preventDefault();
      const from    = fromSelect.value;
      const to      = toSelect.value;
      const invNum  = generateInvoiceNumber();
      const dateStr = new Date().toLocaleDateString();
      const items   = [];

      for (let i = 0; i < itemIndex; i++) {
        const prodEl = document.getElementById(`product-${i}`);
        if (!prodEl) continue;
        const product = prodEl.value;
        const weight  = parseFloat(document.getElementById(`weight-${i}`).value);
        const unit    = document.getElementById(`unit-${i}`).value;
        const cost    = parseFloat(document.getElementById(`cost-${i}`).value);
        const total   = weight * cost;
        items.push({ product, weight, unit, cost, total });
      }

      // Push logs
      const logsRef = ref(db, "logs");
      items.forEach(item => {
        const entryRef = push(logsRef);
        update(entryRef, {
          date: dateStr,
          from,
          to,
          product: item.product,
          weight:  item.weight,
          unit:    item.unit,
          cost:    item.cost,
          total:   item.total,
          invoiceNumber: invNum
        });
      });

      // Generate PDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text(`Invoice #: ${invNum}`, 10, 10);
      doc.text(`Date: ${dateStr}`, 10, 20);
      doc.text(`From: ${from}`, 10, 30);
      doc.text(`To: ${to}`, 10, 40);
      let y = 50;
      items.forEach((itm, idx) => {
        doc.text(
          `${idx+1}. ${itm.product} — ${itm.weight} ${itm.unit} @ ${itm.cost} = ${itm.total}`,
          10,
          y
        );
        y += 10;
      });
      const pdfData = doc.output("datauristring");
      doc.save(`invoice_${invNum}.pdf`);

      // Send via EmailJS
      const serviceID  = "service_gnviol9";
      const templateID = "template_6d3c34k";
      emailjs.send(serviceID, templateID, {
        from_email:    emailMap[from],
        to_email:      emailMap[to],
        invoice_number: invNum,
        invoice_date:   dateStr,
        invoice_pdf:    pdfData
      }).catch(console.error);

      // Reset form
      transferForm.reset();
      document.querySelectorAll(".item-input").forEach((d,i) => { if(i>0) d.remove(); });
      itemIndex = 1;
    });

    // ——— Real-time Logs Display & Actions ———
    const logsRef = ref(db, "logs");
    onChildAdded(logsRef, snap => {
      const log = snap.val(), key = snap.key;
      const tr  = document.createElement("tr");
      tr.innerHTML = `
        <td>${log.date}</td>
        <td>${log.from}</td>
        <td>${log.to}</td>
        <td>${log.product}</td>
        <td>${log.weight}</td>
        <td>${log.unit}</td>
        <td>${log.cost}</td>
        <td>${log.total}</td>
        <td>
          <button class="edit-btn">Edit</button>
          <button class="invoice-btn">Re-Invoice</button>
        </td>
      `;
      // Edit handler
      tr.querySelector(".edit-btn").addEventListener("click", () => {
        // …existing Tracker8 edit logic…
      });
      // Re-Invoice handler
      tr.querySelector(".invoice-btn").addEventListener("click", () => {
        // …reuse PDF+EmailJS logic for this single entry…
      });
      logsTableBody.appendChild(tr);
    });

    // ——— Export Monthly Report as Excel ———
    exportBtn.addEventListener("click", async () => {
      const now   = new Date();
      const month = now.getMonth() + 1;
      const year  = now.getFullYear();
      const snap  = await get(logsRef);
      const data  = [];
      snap.forEach(child => {
        const l = child.val();
        const [m, , y] = l.date.split("/");
        if (+m === month && +y === year) data.push(l);
      });
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Report");
      XLSX.writeFile(wb, `Month_${month}_${year}.xlsx`);
    });

    // ——— AUTO LOGOUT AFTER 10 MINUTES IDLE ———
    let idleTime = 0;
    setInterval(() => {
      idleTime++;
      if (idleTime >= 10) {
        signOut(auth).then(() => location.reload());
      }
    }, 60000);
    ["mousemove","keydown","mousedown","touchstart","scroll"]
      .forEach(evt => document.addEventListener(evt, () => (idleTime = 0)));

    // ——— LOGOUT ON PAGE CLOSE ———
    window.addEventListener("beforeunload", () => {
      signOut(auth);
    });
  </script>
</body>
</html>






