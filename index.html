<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Food Transfer Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial; padding:15px; max-width:700px; margin:auto; background:#f9f9f9 }
    .header { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; }
    h1 { margin:0; font-size:1.8rem; }
    #login-btn { background:#28a745; color:#fff; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; font-size:0.9rem; }
    #login-btn.logout { background:#dc3545; }
    .form-row { margin-bottom:10px }
    input, select, button { width:100%; padding:8px; margin:6px 0; box-sizing:border-box; font-size:1rem }
    label { font-weight:bold; display:block; margin-top:10px }
    .item-group { background:#fff; border:1px solid #ddd; padding:10px; margin-bottom:10px; border-radius:6px }
    .total-value { font-size:0.95rem; color:#333; margin-top:5px; }
    .log-entry { background:#fff; border:1px solid #ccc; padding:10px; margin:8px 0; border-radius:6px }
    .log-entry.completed { opacity:0.6 }
    .completed-label { font-style:italic; color:green; margin-top:5px }
    .admin-only { display:none; }
    body.admin .admin-only { display:block; }
    button.main { background:#007bff; color:#fff; border:none; border-radius:4px; cursor:pointer; transition:background-color .3s }
    button.main:hover { background:#0056b3 }
    button.main:active { background:#003f7f; transform:scale(0.98) }
    @media(min-width:600px){
      .form-row { display:flex; gap:10px }
      input, select { flex:1; width:auto }
      label { display:inline-block; width:auto; margin-top:0 }
    }
  </style>
</head>
<body>

  <div class="header">
    <h1>Food Transfer Tracker</h1>
    <button id="login-btn" type="button">Login</button>
  </div>

  <!-- Date & Location selectors -->
  <div class="form-row">
    <label>Date: <input type="date" id="date"></label>
    <label>From: <select id="from"></select></label>
    <label>To:   <select id="to"></select></label>
  </div>

  <!-- Template for each item block -->
  <template id="item-template">
    <div class="item-group">
      <div class="form-row">
        <label>Product: <input name="product" placeholder="Product name"></label>
        <label>Amount:  <input type="number" name="amount" placeholder="0"></label>
        <label>Unit:    <select name="unit"></select></label>
      </div>
      <div class="form-row">
        <label>Cost per <span class="unit-label">unit</span>: <input type="number" step="0.01" name="cost" placeholder="$"></label>
        <div class="total-value"></div>
        <label>Comment: <input name="comment" placeholder="Optional comment"></label>
      </div>
    </div>
  </template>

  <!-- Container and action buttons -->
  <div id="items-container"></div>
  <button id="add-item-btn" type="button" class="main">Additional Items</button>
  <button id="submit-btn" type="button" class="main">Submit Transfer</button>

  <!-- Logs section -->
  <h2>
    Logs for
    <button class="main" type="button" onclick="changeMonth(-1)">&lt;</button>
    <span id="current-month"></span>
    <button class="main" type="button" onclick="changeMonth(1)">&gt;</button>
  </h2>
  <div id="logs"></div>

  <!-- Admin tools -->
  <button class="main admin-only" type="button" onclick="exportExcel()">Download Monthly Report</button>
  <div class="admin-only" style="margin-top:10px;">
    <label style="display:inline-block; margin-right:8px;">From: <input type="date" id="report-start"></label>
    <label style="display:inline-block; margin-right:8px;">To:   <input type="date" id="report-end"></label>
    <button class="main" type="button" onclick="exportDateRange()">Download Report by Date</button>
  </div>

  <!-- NEW: Admin invoice by date range -->
  <div class="admin-only" style="margin-top:16px; padding-top:10px; border-top:1px solid #ddd;">
    <h3>Generate Transfer Invoice (by Date Range)</h3>
    <label style="display:inline-block; margin-right:8px;">
      Location:
      <select id="invoice-location" style="min-width:180px;"></select>
    </label>
    <label style="display:inline-block; margin-right:8px;">
      From:
      <input type="date" id="invoice-start">
    </label>
    <label style="display:inline-block; margin-right:8px;">
      To:
      <input type="date" id="invoice-end">
    </label>
    <button class="main" type="button" id="invoice-generate">Preview & Download PDF</button>
  </div>

  <!-- External libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    const ADMIN_PASSWORD = "SuperSecret123";
    function $(id){ return document.getElementById(id); }

    // ----- Initialize Firebase -----
    const firebaseConfig = {
      apiKey: "AIzaSyAMnZy_gRIu43w6RyvcgRFHcV6xQjBAriM",
      authDomain: "food-tracker-fd312.firebaseapp.com",
      databaseURL: "https://food-tracker-fd312-default-rtdb.firebaseio.com",
      projectId: "food-tracker-fd312",
      storageBucket: "food-tracker-fd312.firebasestorage.app",
      messagingSenderId: "1012475913662",
      appId: "1:1012475913662:web:81837595030d4b8a8105ef"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ----- Static data -----
    const locations = ["Prohibition","Tulia Osteria","Ce Soir","Beacon"];
    const units     = ["oz","lb","kg","fl oz","ml","L"];
    let selectedMonth = new Date().toISOString().slice(0,7);

    // ----- Admin login toggle -----
    function isAdmin(){ return localStorage.getItem("isAdmin")==="true"; }
    function setAdmin(v){
      localStorage.setItem("isAdmin", v?"true":"false");
      document.body.classList.toggle("admin", v);
      const btn = $("login-btn");
      btn.textContent = v ? "Logout" : "Login";
      btn.classList.toggle("logout", v);
      loadLogs();
    }
    $("login-btn").addEventListener("click", ()=>{
      if(isAdmin()) return setAdmin(false);
      const pw = prompt("Enter admin password:");
      if(pw===ADMIN_PASSWORD) setAdmin(true);
      else alert("Incorrect password.");
    });

    // ----- Setup UI on load -----
    async function setupUI(){
      $("date").valueAsDate = new Date();

      // populate From/To selects
      locations.forEach(loc=>{ ["from","to"].forEach(id=>{
        const o = document.createElement("option"); o.value=o.textContent=loc;
        $(id).appendChild(o);
      }); });

      // NEW: populate invoice location and default date range
      locations.forEach(loc=>{
        const o = document.createElement("option"); o.value = o.textContent = loc;
        $("invoice-location").appendChild(o);
      });
      $("invoice-start").value = new Date().toISOString().slice(0,10);
      $("invoice-end").value   = new Date().toISOString().slice(0,10);
      $("invoice-generate").addEventListener("click", generateInvoiceByRange);

      $("add-item-btn").addEventListener("click", addItem);
      $("submit-btn").addEventListener("click", addTransfer);
      addItem();
      setAdmin(isAdmin());
      $("report-start").value = new Date().toISOString().slice(0,10);
      $("report-end").value   = new Date().toISOString().slice(0,10);
    }

    // ----- Add one item block -----
    function addItem(){
      const frag     = $("item-template").content.cloneNode(true);
      const sel      = frag.querySelector('select[name="unit"]');
      const label    = frag.querySelector('.unit-label');
      const amtInput = frag.querySelector('input[name="amount"]');
      const costInput= frag.querySelector('input[name="cost"]');
      const totalDiv = frag.querySelector('.total-value');
      units.forEach(u=>{ const o=document.createElement("option"); o.value=o.textContent=u; sel.appendChild(o); });
      label.textContent = sel.value;
      function updateVal(){
        label.textContent = sel.value;
        const a=parseFloat(amtInput.value), c=parseFloat(costInput.value);
        totalDiv.textContent = (!isNaN(a)&&!isNaN(c))? `Total: $${(a*c).toFixed(2)}` : "";
      }
      sel.addEventListener("change", updateVal);
      amtInput.addEventListener("input", updateVal);
      costInput.addEventListener("input", updateVal);
      $("items-container").appendChild(frag);
    }

    // ----- Load & display logs -----
    async function loadLogs(){
      $("logs").innerHTML = "";
      $("current-month").textContent = selectedMonth;
      for(const store of locations){
        const sec = document.createElement("div");
        sec.innerHTML = `<h3>${store}</h3>`;
        const snap = await db.ref(`logs/${store}/${selectedMonth}`).once("value");
        const data = snap.val();
        if(data) Object.entries(data).forEach(([key,log])=> sec.appendChild(renderLogEntry(store,selectedMonth,key,log)));
        $("logs").appendChild(sec);
      }
    }

    function renderLogEntry(store,month,key,log){
      const div = document.createElement("div");
      div.className = log.completed?"log-entry completed":"log-entry";
      const costTxt  = log.costPerUnit?` @ $${Number(log.costPerUnit).toFixed(2)} each`:"";
      const totalTxt = log.costPerUnit?` = $${(log.amount*log.costPerUnit).toFixed(2)}`:"";
      const color    = log.amount<0?"red":"green";
      const display  = log.amount<0?log.amount:`+${log.amount}`;
      div.innerHTML = `
        <span style="color:${color};font-size:0.95rem">
          ${display} ${log.unit} of ${log.product}${costTxt}${totalTxt}
          (${log.date}${log.comment?` | ${log.comment}`:""})
        </span>`;
      if(log.completed){
        const lbl=document.createElement("div");
        lbl.className="completed-label";
        lbl.textContent="Completed";
        div.appendChild(lbl);
      }
      return div;
    }

    // ----- Submit all items as transfers -----
    async function addTransfer(){
      const date = $("date").value, from = $("from").value, to = $("to").value;
      if(!date||!from||!to||from===to) return alert("Select date and/from/to with From≠To.");
      selectedMonth = date.slice(0,7);
      const mk = selectedMonth;
      const groups = document.querySelectorAll('.item-group');
      for(const g of groups){
        const product = g.querySelector('[name="product"]').value.trim();
        const amt     = parseFloat(g.querySelector('[name="amount"]').value);
        const unit    = g.querySelector('[name="unit"]').value;
        const cpu     = g.querySelector('[name="cost"]').value === "" ? null : parseFloat(g.querySelector('[name="cost"]').value);
        const cmnt    = g.querySelector('[name="comment"]').value||"";
        if(!product||isNaN(amt)||!unit) return alert("Complete all item fields.");
        const key = db.ref('logs').push().key;
        const out = { date, from, to, product, unit, costPerUnit:cpu, comment:cmnt, completed:false, amount:-amt };
        const inLog = { date, from, to, product, unit, costPerUnit:cpu, comment:cmnt, completed:false, amount: amt };
        const upd={};
        upd[`logs/${from}/${mk}/${key}`]=out;
        upd[`logs/${to}/${mk}/${key}`]=inLog;
        await db.ref().update(upd);
      }
      $("items-container").innerHTML=""; $("date").valueAsDate=new Date();
      $("from").selectedIndex=$("to").selectedIndex=0;
      addItem();
      loadLogs();
    }

    // ----- Month nav & Excel export -----
    function changeMonth(offset){
      const [y,m] = selectedMonth.split("-").map(Number);
      const d = new Date(y, m-1+offset);
      selectedMonth = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
      loadLogs();
    }

    function exportExcel(){
      db.ref("logs").once("value").then(snapshot=>{
        const wb = XLSX.utils.book_new();
        snapshot.forEach(storeSnap=>{
          const rows=[];
          storeSnap.forEach(monthSnap=>{
            monthSnap.forEach(logSnap=>{
              const l=logSnap.val();
              const tot=l.costPerUnit?(l.amount*l.costPerUnit).toFixed(2):"";
              rows.push([l.date,l.from,l.to,l.product,l.amount,l.unit,l.costPerUnit||"",tot,l.comment||""]);
            });
          });
          const ws = XLSX.utils.aoa_to_sheet([["Date","From","To","Product","Amount","Unit","Cost","Total","Comment"],...rows]);
          XLSX.utils.book_append_sheet(wb,ws,storeSnap.key.slice(0,31));
        });
        XLSX.writeFile(wb,`FoodTransfers_${selectedMonth}.xlsx`);
      });
    }

    function exportDateRange(){
      const startD=new Date($("report-start").value), endD=new Date($("report-end").value);
      if(isNaN(startD)||isNaN(endD)) return alert("Please select both start and end dates.");
      db.ref("logs").once("value").then(snapshot=>{
        const wb = XLSX.utils.book_new();
        snapshot.forEach(storeSnap=>{
          const rows=[];
          storeSnap.forEach(monthSnap=>{
            monthSnap.forEach(logSnap=>{
              const l=logSnap.val(), d=new Date(l.date);
              if(d>=startD&&d<=endD){
                const tot=l.costPerUnit?(l.amount*l.costPerUnit).toFixed(2):"";
                rows.push([l.date,l.from,l.to,l.product,l.amount,l.unit,l.costPerUnit||"",tot,l.comment||""]);
              }
            });
          });
          if(rows.length){
            const ws = XLSX.utils.aoa_to_sheet([["Date","From","To","Product","Amount","Unit","Cost","Total","Comment"],...rows]);
            XLSX.utils.book_append_sheet(wb,ws,storeSnap.key.slice(0,31));
          }
        });
        XLSX.writeFile(wb,`Report_${$("report-start").value}_${$("report-end").value}.xlsx`);
      });
    }

    // ===== New: Date-range invoice generator =====

    // Make YYYY-MM list between two YYYY-MM-DD strings
    function monthKeysBetween(startStr, endStr) {
      const [sy, sm] = startStr.slice(0,7).split("-").map(Number);
      const [ey, em] = endStr.slice(0,7).split("-").map(Number);
      const months = [];
      let y = sy, m = sm;
      while (y < ey || (y === ey && m <= em)) {
        months.push(`${y}-${String(m).padStart(2,"0")}`);
        m++; if (m === 13) { m = 1; y++; }
      }
      return months;
    }

    async function loadLocationLogsByRange(location, startStr, endStr) {
      const months = monthKeysBetween(startStr, endStr);
      const rows = [];
      for (const mk of months) {
        const snap = await db.ref(`logs/${location}/${mk}`).once("value");
        const data = snap.val();
        if (!data) continue;
        for (const [key, l] of Object.entries(data)) {
          if (!l?.date) continue;
          if (l.date >= startStr && l.date <= endStr) {
            const amount = Number(l.amount || 0);                 // signed
            const cpu    = l.costPerUnit != null ? Number(l.costPerUnit) : null;
            const line   = cpu != null ? amount * cpu : 0;        // signed (0 if no cost)
            rows.push({
              key,
              date: l.date,
              from: l.from,
              to:   l.to,
              product: l.product,
              unit: l.unit,
              costPerUnit: cpu,
              amount,
              lineTotal: line,
              comment: l.comment || ""
            });
          }
        }
      }
      rows.sort((a,b) => (a.date.localeCompare(b.date) || String(a.product).localeCompare(String(b.product))));
      return rows;
    }

    function money(n, currency="CAD") {
      return Number(n||0).toLocaleString(undefined, { style:"currency", currency });
    }

    function buildInvoicePDF({ location, startStr, endStr, rows }) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const title = `Transfer Invoice — ${location}`;
      const range = `${startStr} to ${endStr}`;
      const netTotal = rows.reduce((a,r)=>a + r.lineTotal, 0);

      // Header
      doc.setFontSize(16);
      doc.text(title, 14, 18);
      doc.setFontSize(11);
      doc.text(`Date range: ${range}`, 14, 26);
      doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 32);

      // Columns
      let y = 42;
      doc.setFontSize(10);
      doc.text("Date",       14, y);
      doc.text("From",       32, y);
      doc.text("To",         66, y);
      doc.text("Product",    96, y);
      doc.text("Qty",       146, y, { align:"right" });
      doc.text("Unit",      160, y, { align:"right" });
      doc.text("Cost",      176, y, { align:"right" });
      doc.text("Line Total",196, y, { align:"right" });
      doc.line(14, y+2, 196, y+2);
      y += 8;

      const lineH = 6;
      rows.forEach(r => {
        if (y > 280) { doc.addPage(); y = 20; }
        const qtyLabel = (r.amount >= 0 ? "+" : "–") + Math.abs(r.amount);
        const unit     = r.unit || "";
        const cost     = r.costPerUnit != null ? money(r.costPerUnit) : "-";
        const line     = r.costPerUnit != null ? ((r.lineTotal >= 0 ? "+" : "–") + money(Math.abs(r.lineTotal))) : "-";

        doc.text(r.date, 14, y);
        doc.text(String(r.from||""), 32, y);
        doc.text(String(r.to||""),   66, y);
        doc.text(String(r.product||""), 96, y);
        doc.text(qtyLabel, 146, y, { align:"right" });
        doc.text(unit,     160, y, { align:"right" });
        doc.text(cost,     176, y, { align:"right" });
        doc.text(line,     196, y, { align:"right" });

        y += lineH;

        if (r.comment) {
          if (y > 280) { doc.addPage(); y = 20; }
          doc.setFontSize(9);
          doc.text(`Note: ${r.comment}`, 32, y);
          doc.setFontSize(10);
          y += lineH;
        }
      });

      // Totals
      doc.line(120, y+2, 196, y+2);
      y += 8;
      doc.setFontSize(12);
      doc.text("Net Total:", 176, y, { align:"right" });
      doc.text((netTotal >= 0 ? "+" : "–") + money(Math.abs(netTotal)), 196, y, { align:"right" });

      // Legend
      y += 10;
      doc.setFontSize(9);
      doc.text("Legend: Qty and Line Total show + for incoming to this location, – for outgoing from this location.", 14, y);

      const file = `Invoice_${location.replace(/\s+/g,'')}_${startStr}_${endStr}.pdf`;
      doc.save(file);
    }

    async function generateInvoiceByRange() {
      const location = $("invoice-location").value;
      const startStr = $("invoice-start").value;
      const endStr   = $("invoice-end").value;

      if (!location || !startStr || !endStr) {
        alert("Please select location, start and end dates.");
        return;
      }
      if (startStr > endStr) {
        alert("Start date must be before end date.");
        return;
      }

      const rows = await loadLocationLogsByRange(location, startStr, endStr);
      if (!rows.length) {
        alert("No transfers found for that selection.");
        return;
      }
      buildInvoicePDF({ location, startStr, endStr, rows });
    }

    // Bootstrap
    setupUI();

    // ----- AUTO LOGOUT AFTER 10 MINUTES IDLE -----
    let idleTimeout;
    function resetIdleTimer(){
      clearTimeout(idleTimeout);
      idleTimeout = setTimeout(()=>{
        if(isAdmin()){
          alert("You have been logged out due to 10 minutes of inactivity.");
          setAdmin(false);
        }
      },10*60*1000);
    }
    ["mousemove","keydown","mousedown","touchstart","scroll"].forEach(evt=>{
      document.addEventListener(evt, resetIdleTimer, false);
    });
    resetIdleTimer();

    // ----- LOGOUT ON PAGE CLOSE -----
    window.addEventListener("beforeunload", ()=>{
      if(isAdmin()) setAdmin(false);
    });
  </script>
</body>
</html>

