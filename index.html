<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Food Transfer Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
</head>
<body>
  <h1>Food Transfer Tracker</h1>
  <form id="transferForm">
    <label>From:
      <select id="from"></select>
    </label>
    <label>To:
      <select id="to"></select>
    </label>
    <label>Product:
      <input id="product" type="text" />
    </label>
    <label>Amount:
      <input id="amount" type="number" step="0.01" />
    </label>
    <label>Unit:
      <select id="unit"></select>
    </label>
    <label>Cost per Unit:
      <input id="cost" type="number" step="0.01" />
    </label>
    <div id="unit-label"></div>
    <div id="total-value"></div>
    <button type="submit">Submit Transfer</button>
  </form>

  <div id="log"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, update, get } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAdWAxKfSLI7jf7vJSwrIXogvL3LRW-GFU",
      authDomain: "aidan-food-tracker.firebaseapp.com",
      projectId: "aidan-food-tracker",
      storageBucket: "aidan-food-tracker.appspot.com",
      messagingSenderId: "397728832351",
      appId: "1:397728832351:web:33645f7f37ee1f277ff4ea",
      databaseURL: "https://aidan-food-tracker-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const locations = ["Prohibition", "Tulia Osteria", "Ce Soir", "Beacon"];
    const units = ["oz", "lb", "kg", "fl oz", "ml", "L"];

    function $(id) { return document.getElementById(id); }

    function setupUI() {
      locations.forEach(loc => {
        ["from", "to"].forEach(id => {
          const opt = document.createElement("option");
          opt.value = opt.textContent = loc;
          $(id).appendChild(opt);
        });
      });
      units.forEach(unit => {
        const opt = document.createElement("option");
        opt.value = opt.textContent = unit;
        $("unit").appendChild(opt);
      });

      $("unit").addEventListener("change", updateUnitLabel);
      $("cost").addEventListener("input", updateTotalValue);
      $("amount").addEventListener("input", updateTotalValue);
    }

    function updateUnitLabel() {
      $("unit-label").textContent = $("unit").value;
      updateTotalValue();
    }

    function updateTotalValue() {
      const amount = parseFloat($("amount").value);
      const cost = parseFloat($("cost").value);
      if (!isNaN(amount) && !isNaN(cost)) {
        const total = (amount * cost).toFixed(2);
        $("total-value").textContent = `Total Value: $${total}`;
      } else {
        $("total-value").textContent = "";
      }
    }

    async function getNextInvoiceNumber() {
      const counterRef = ref(db, "invoiceCounter");
      const snapshot = await get(counterRef);
      let current = snapshot.exists() ? snapshot.val() : 1000;
      const next = current + 1;
      await update(ref(db), { invoiceCounter: next });
      return next;
    }

    function createInvoiceContent(data, invoiceNumber) {
      const { from, to, product, amount, unit, cost, date } = data;
      const isOutgoing = true;
      const adjustedAmount = -Math.abs(amount);
      const adjustedValue = -(amount * cost);

      return `Invoice #: ${invoiceNumber}\nDate: ${date}\nFrom: ${from} to ${to}\n\nProduct: ${product}\nAmount: ${adjustedAmount} ${unit}\nCost per Unit: $${cost.toFixed(2)}\nTotal Value: $${adjustedValue.toFixed(2)}`;
    }

    async function sendInvoiceEmail(data, invoiceNumber) {
      const emails = {
        "Prohibition": "accounts@prohibitionsocialhouse.com",
        "Beacon": "accounts@beaconsocialhouse.com",
        "Tulia Osteria": "accounts@tuliaosteria.com",
        "Ce Soir": "accounts@cesoirbrasserie.com"
      };

      const emailParams = {
        to_email: emails[data.to],
        subject: `Aidan Food Transfer - ${data.date} - Invoice #${invoiceNumber}`,
        message: createInvoiceContent(data, invoiceNumber)
      };

      return emailjs.send("service_gnviol9", "template_6d3c34k", emailParams, "53xKou9OzR6BhrdWL");
    }

    function loadLogs() {
      const logRef = ref(db, "logs");
      onValue(logRef, snapshot => {
        const logDiv = $("log");
        logDiv.innerHTML = "";
        snapshot.forEach(child => {
          const log = child.val();
          const div = document.createElement("div");
          div.textContent = `${log.date}: ${log.product} (${log.amount} ${log.unit}) from ${log.from} to ${log.to}`;
          const btn = document.createElement("button");
          btn.textContent = "Create Invoice";
          btn.onclick = async () => {
            const invoiceNumber = await getNextInvoiceNumber();
            sendInvoiceEmail(log, invoiceNumber)
              .then(() => alert("Invoice sent!"))
              .catch(err => alert("Failed to send: " + err.message));
          };
          div.appendChild(btn);
          logDiv.appendChild(div);
        });
      });
    }

    $("transferForm").addEventListener("submit", async e => {
      e.preventDefault();
      const data = {
        from: $("from").value,
        to: $("to").value,
        product: $("product").value,
        amount: parseFloat($("amount").value),
        unit: $("unit").value,
        cost: parseFloat($("cost").value),
        date: new Date().toISOString().split("T")[0]
      };
      await push(ref(db, "logs"), data);
    });

    setupUI();
    loadLogs();
  </script>
</body>
</html>


