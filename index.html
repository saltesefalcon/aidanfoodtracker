<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Aidan Food Tracker</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, set, update } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";
    import * as XLSX from "https://cdn.sheetjs.com/xlsx-0.20.0/package/xlsx.mjs";

    const firebaseConfig = {
      apiKey: "AIzaSyAdWAxKfSLI7jf7vJSwrIXogvL3LRW-GFU",
      authDomain: "aidan-food-tracker.firebaseapp.com",
      projectId: "aidan-food-tracker",
      storageBucket: "aidan-food-tracker.appspot.com",
      messagingSenderId: "397728832351",
      appId: "1:397728832351:web:33645f7f37ee1f277ff4ea",
      databaseURL: "https://aidan-food-tracker-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const locations = ["Prohibition", "Rebellion", "Sanctuary", "Forbidden"];
    const units = ["oz", "lb", "kg", "fl oz", "ml", "L"];

    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("transferForm");
      const logsContainer = document.getElementById("logs");
      const reportBtn = document.getElementById("downloadReport");

      // Populate location & unit dropdowns
      locations.forEach(loc => {
        const optionFrom = new Option(loc, loc);
        const optionTo = new Option(loc, loc);
        document.getElementById("from").append(optionFrom);
        document.getElementById("to").append(optionTo);
      });
      units.forEach(u => document.getElementById("unit").append(new Option(u, u)));

      // Cost per unit field handler
      document.getElementById("unit").addEventListener("change", () => {
        const unit = document.getElementById("unit").value;
        document.getElementById("costLabel").innerText = `Cost per ${unit}`;
        document.getElementById("costSection").style.display = "block";
      });

      form.addEventListener("submit", async e => {
        e.preventDefault();
        const data = {
          date: document.getElementById("date").value,
          from: document.getElementById("from").value,
          to: document.getElementById("to").value,
          product: document.getElementById("product").value.trim(),
          amount: parseFloat(document.getElementById("amount").value),
          unit: document.getElementById("unit").value,
          costPerUnit: parseFloat(document.getElementById("costPerUnit").value) || 0,
          comment: document.getElementById("comment").value.trim(),
        };
        data.totalCost = +(data.amount * data.costPerUnit).toFixed(2);

        const month = data.date.slice(0, 7);

        const fromRef = ref(db, `logs/${data.from}/${month}`);
        const toRef = ref(db, `logs/${data.to}/${month}`);

        const outLog = { ...data, amount: -Math.abs(data.amount), totalCost: -Math.abs(data.totalCost) };
        const inLog = { ...data };

        await push(fromRef, outLog);
        await push(toRef, inLog);

        form.reset();
        document.getElementById("costSection").style.display = "none";
        loadLogs();
      });

      async function loadLogs() {
        logsContainer.innerHTML = "";
        locations.forEach(location => {
          const locDiv = document.createElement("div");
          locDiv.innerHTML = `<details><summary><strong>${location}</strong></summary><div id="${location}-logs"></div></details>`;
          logsContainer.appendChild(locDiv);

          const locRef = ref(db, `logs/${location}`);
          onValue(locRef, snapshot => {
            const storeDiv = document.getElementById(`${location}-logs`);
            storeDiv.innerHTML = "";
            const data = snapshot.val();
            if (!data) return;

            Object.keys(data).forEach(month => {
              const monthDiv = document.createElement("div");
              monthDiv.innerHTML = `<h4>${month}</h4>`;
              data[month] && Object.entries(data[month]).forEach(([id, entry]) => {
                const row = document.createElement("div");
                row.innerHTML = `
                  <div style="margin: 5px 0; border: 1px solid #ccc; padding: 5px;">
                    <input value="${entry.date}" />
                    <input value="${entry.product}" />
                    <input value="${entry.amount}" />
                    <input value="${entry.unit}" />
                    <input value="${entry.costPerUnit || 0}" />
                    <input value="${entry.comment || ''}" />
                    <button>ðŸ’¾</button>
                  </div>
                `;
                const btn = row.querySelector("button");
                btn.onclick = () => {
                  const inputs = row.querySelectorAll("input");
                  const updated = {
                    date: inputs[0].value,
                    product: inputs[1].value,
                    amount: parseFloat(inputs[2].value),
                    unit: inputs[3].value,
                    costPerUnit: parseFloat(inputs[4].value) || 0,
                    comment: inputs[5].value.trim(),
                    from: entry.from,
                    to: entry.to,
                    totalCost: +(parseFloat(inputs[2].value) * (parseFloat(inputs[4].value) || 0)).toFixed(2)
                  };
                  const updateRef = ref(db, `logs/${location}/${month}/${id}`);
                  set(updateRef, updated);
                };
                monthDiv.appendChild(row);
              });
              storeDiv.appendChild(monthDiv);
            });
          });
        });
      }

      async function downloadReport() {
        const snapshot = await import("https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js")
          .then(({ getDatabase, ref, get }) => get(ref(db, 'logs')));
        const data = (await snapshot.val()) || {};

        const wb = XLSX.utils.book_new();
        Object.entries(data).forEach(([store, months]) => {
          let rows = [["Date", "Product", "Amount", "Unit", "Cost per Unit", "Total Cost", "From", "To", "Comment"]];
          Object.entries(months).forEach(([month, logs]) => {
            Object.values(logs).forEach(log => {
              rows.push([
                log.date, log.product, log.amount, log.unit,
                log.costPerUnit || 0, log.totalCost || 0,
                log.from, log.to, log.comment || ""
              ]);
            });
          });
          const sheet = XLSX.utils.aoa_to_sheet(rows);
          XLSX.utils.book_append_sheet(wb, sheet, store);
        });

        XLSX.writeFile(wb, `Food_Transfers_${new Date().toISOString().slice(0,7)}.xlsx`);
      }

      reportBtn.onclick = downloadReport;
      loadLogs();
    });
  </script>
</head>
<body>
  <h1>Aidan Food Transfer Tracker</h1>
  <form id="transferForm">
    <label>Date: <input type="date" id="date" required /></label><br/>
    <label>From: <select id="from"></select></label><br/>
    <label>To: <select id="to"></select></label><br/>
    <label>Product: <input type="text" id="product" required /></label><br/>
    <label>Amount: <input type="number" step="0.01" id="amount" required /></label><br/>
    <label>Unit: <select id="unit" required></select></label><br/>
    <div id="costSection" style="display:none;">
      <label id="costLabel">Cost per unit: <input type="number" step="0.01" id="costPerUnit" /></label><br/>
    </div>
    <label>Comment: <input type="text" id="comment" /></label><br/>
    <button type="submit">Submit Transfer</button>
  </form>
  <br/>
  <button id="downloadReport">Download Monthly Report</button>
  <hr/>
  <div id="logs"></div>
</body>
</html>
