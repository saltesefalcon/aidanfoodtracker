<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aidan Food Tracker</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script type="text/javascript" src="https://cdn.emailjs.com/dist/email.min.js"></script>
</head>

<body>
  <div id="app"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, push, set, get, child } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // Initialize EmailJS
    emailjs.init("YOUR_PUBLIC_KEY");

    // Sample log object (to be replaced with actual data)
    const log = {
      from: "Prohibition",
      to: "Tulia Osteria",
      date: "2025-07-29",
      product: "Chicken Thighs",
      amount: 15,
      unit: "lb",
      costPerUnit: 4.5,
      comment: "Special order for Friday"
    };

    const recipients = {
      "Prohibition": "accounts@prohibitionsocialhouse.com",
      "Beacon": "accounts@beaconsocialhouse.com",
      "Tulia Osteria": "accounts@tuliaosteria.com",
      "Ce Soir": "accounts@cesoirbrasserie.com"
    };

    async function sendInvoice({ log, invoiceNumber, pdfDataUri }) {
      const templateID = "transfer_invoice";
      const serviceID = "service_gnviol9";

      const subject = `Aidan Food Transfer - ${log.date} - #${invoiceNumber}`;
      const message = `
        Invoice #${invoiceNumber}
        From: ${log.from}
        To: ${log.to}
        Date: ${log.date}
        Product: ${log.product}
        Amount: ${log.amount} ${log.unit}
        Cost Per Unit: $${log.costPerUnit ?? "N/A"}
        Total Value: $${(log.amount * (log.costPerUnit ?? 0)).toFixed(2)}
      `;

      const toEmailFrom = recipients[log.from];
      const toEmailTo = recipients[log.to];

      try {
        await emailjs.send(serviceID, templateID, {
          to_email: toEmailFrom,
          subject,
          message,
          pdf_base64: pdfDataUri
        });

        await emailjs.send(serviceID, templateID, {
          to_email: toEmailTo,
          subject,
          message,
          pdf_base64: pdfDataUri
        });

        alert(`Invoice #${invoiceNumber} sent to ${log.from} and ${log.to}`);
      } catch (error) {
        console.error("Error sending invoice via EmailJS:", error);
        alert("Failed to send invoice. Please try again.");
      }
    }

    // You would call sendInvoice(log, invoiceNumber, pdfDataUri) after generating the PDF
  </script>
</body>

</html>
